<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>goWebU 图形界面</title>
</head>
<body>
<h1>goWebU</h1>
<p>用于管理和启动 SSH 隧道的简易界面。</p>
<section>
<h2>主机</h2>
<p>在此保存 SSH 主机及凭据，密码或密钥二选一。</p>
<button onclick="loadHosts()">刷新</button>
<ul id="hostList"></ul>
<form id="hostForm">
<input name="name" placeholder="名称">
<input name="host" placeholder="主机">
<input name="port" type="number" placeholder="端口" value="22">
<input name="username" placeholder="用户名">
<select name="auth_type">
<option value="password">密码</option>
<option value="key">密钥</option>
</select>
<input name="key_alias" placeholder="密钥别名/密钥">
<input name="password" type="password" placeholder="密码">
<button type="submit">保存</button>
</form>
</section>
<section>
<h2>启动隧道</h2>
<p>选择上方的主机并填写端口信息，点击启动建立隧道。</p>
<form id="startForm">
<select name="host_id" id="hostSelect"></select>
<div id="forwardList">
 <div class="forward">
  <label>本地端口 <input name="lport" type="number" value="9000"></label>
  <label>远程主机 <input name="rhost" value="localhost"></label>
  <label>远程端口 <input name="rport" type="number" value="5432"></label>
 </div>
</div>
<button type="button" onclick="addForward()">添加端口</button>
<button type="submit">启动</button>
</form>
<div id="sessionId"></div>
</section>
<section>
<h2>会话管理</h2>
<form id="sessionForm">
<input name="session_id" placeholder="会话ID">
<button type="submit">状态</button>
<button type="button" onclick="stopSession()">停止</button>
</form>
<div id="sessionStatus"></div>
</section>
<section>
<h2>历史</h2>
<p>仅显示已成功连接的隧道记录。</p>
<button onclick="loadHistory()">刷新</button>
<ul id="historyList"></ul>
</section>
<script>
async function loadHosts(){
 const res=await fetch('/hosts');
 const hosts=await res.json();
 const list=document.getElementById('hostList');
 list.innerHTML='';
 const sel=document.getElementById('hostSelect');
 sel.innerHTML='';
 hosts.forEach(h=>{
  const li=document.createElement('li');
  li.textContent=h.id+' '+h.username+'@'+h.host+':'+h.port;
  list.appendChild(li);
  const opt=document.createElement('option');
  opt.value=h.id;
  opt.textContent=li.textContent;
  sel.appendChild(opt);
 });
}

document.getElementById('hostForm').addEventListener('submit',async(e)=>{
 e.preventDefault();
 const f=e.target;
 const payload={name:f.name.value,host:f.host.value,port:parseInt(f.port.value),username:f.username.value,auth_type:f.auth_type.value,key_alias:f.key_alias.value,password:f.password.value};
 await fetch('/hosts',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
 f.reset();
 loadHosts();
});

document.getElementById('startForm').addEventListener('submit',async(e)=>{
 e.preventDefault();
 const f=e.target;
 const forwards=[];
 document.querySelectorAll('#forwardList .forward').forEach(row=>{
  forwards.push({
   lport:parseInt(row.querySelector('input[name="lport"]').value),
   rhost:row.querySelector('input[name="rhost"]').value,
   rport:parseInt(row.querySelector('input[name="rport"]').value)
  });
 });
 const payload={host_id:parseInt(f.host_id.value),forwards:forwards};
 const res=await fetch('/start',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
 const data=await res.json();
 document.getElementById('sessionId').textContent=data.session_id?('会话: '+data.session_id):('错误: '+data.error);
});

function addForward(){
 const div=document.createElement('div');
 div.className='forward';
 div.innerHTML='<label>本地端口 <input name="lport" type="number" value="9000"></label> <label>远程主机 <input name="rhost" value="localhost"></label> <label>远程端口 <input name="rport" type="number" value="5432"></label>';
 document.getElementById('forwardList').appendChild(div);
}

document.getElementById('sessionForm').addEventListener('submit',async(e)=>{
 e.preventDefault();
 const id=e.target.session_id.value;
 const res=await fetch('/status',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({session_id:id})});
 const data=await res.json();
 document.getElementById('sessionStatus').textContent=data.alive?'连接正常':'连接已断开';
});

async function stopSession(){
 const f=document.getElementById('sessionForm');
 const id=f.session_id.value;
 await fetch('/stop',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({session_id:id})});
 document.getElementById('sessionStatus').textContent='已停止';
}

async function loadHistory(){
 const res=await fetch('/history');
 const list=await res.json();
 const ul=document.getElementById('historyList');
 ul.innerHTML='';
 list.forEach(it=>{
  const li=document.createElement('li');
  li.textContent=it.raw;
  ul.appendChild(li);
 });
}

loadHosts();
loadHistory();
</script>
</body>
</html>
